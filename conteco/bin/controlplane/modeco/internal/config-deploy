#!/usr/bin/env bash
rootPath=$1
basePath="$rootPath/modeco"
DOLLAR='$'

export CONTECO_MODULEPREFIX="package"
if [[ "$CONTECO_TYPE" != "package" ]] ; then
	export CONTECO_MODULEPREFIX="${CONTECO_TYPE}_${CONTECO_NAME}"
fi

echo $'#!/usr/bin/env bash\n\n' > $basePath/deploy-local-down
echo "prefix=\"${CONTECO_TYPE}_${DOLLAR}2\"
" >> $basePath/deploy-local-down
cp $basePath/deploy-local-down $basePath/deploy-local-up

echo "
executionplane --silent docker container prune --force
" >> $basePath/deploy-local-down

IFS=$'\n' read -d '' -r -a volumes < $basePath/module-volumes
for volume in ${volumes[@]};
do
	#	executionplane --silent docker volume rm --force ${volume}
	echo "if [[ \"${CONTECO_MODULEPREFIX}_${volume}\" == \"${DOLLAR}prefix\"* ]] ; then
		continue=\"true\"
		while [[ \"true\" == \"${DOLLAR}continue\" ]] ;
		do
			executionplane docker volume rm \"${CONTECO_MODULEPREFIX}_${volume}\"
			result=${DOLLAR}(docker volume ls | grep \"${CONTECO_MODULEPREFIX}_${volume}\")
			if [[ \"${DOLLAR}result\" == \"\" ]] ; then
				continue=\"false\"
			else
				sleep 3;
			fi
		done;
	fi
	" >> $basePath/deploy-local-down
	echo "if [[ \"${CONTECO_MODULEPREFIX}_${volume}\" == \"${DOLLAR}prefix\"* ]] ; then
	executionplane --silent docker volume create ${CONTECO_MODULEPREFIX}_${volume}
	fi
	" >> $basePath/deploy-local-up
done;

IFS=$'\n' read -d '' -r -a volumes < $basePath/module-volumes-initialised
for volumeSettings in ${volumes[@]};
do
	volumeName=$(echo $volumeSettings | cut -d':' -f 1)
	volumeDir=$(echo $volumeSettings | cut -d':' -f 2)
	if [[ -d "$rootPath/modeco/volumes/${volumeName}" ]] ; then
		echo "if [[ \"${CONTECO_MODULEPREFIX}_${volumeName}\" == \"${DOLLAR}prefix\"* ]] ; then
			executionplane --silent docker run -v ${CONTECO_MODULEPREFIX}_${volumeName}:${volumeDir} ${DOLLAR}{CONTECO_REGISTRY}${DOLLAR}1 --interactive cp -r /modeco/volumes/${volumeName}/* ${volumeDir}
		fi
		" >> $basePath/deploy-local-up
	else
		echo "if [[ \"${CONTECO_MODULEPREFIX}_${volumeName}\" == \"${DOLLAR}prefix\"* ]] ; then
			executionplane --silent docker run -v ${CONTECO_MODULEPREFIX}_${volumeName}:${volumeDir} ${DOLLAR}{CONTECO_REGISTRY}${DOLLAR}1 --interactive tar -C / -xvf /modeco/volumes/${volumeName}.tar
		fi
		" >> $basePath/deploy-local-up
	fi
done;

chmod -R 777 $basePath
