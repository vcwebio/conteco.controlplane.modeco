#!/usr/bin/env bash
(
	imageName="$1"
	rootPath="$2"
	stack="$3"
	. $rootPath/modeco/settings
	volumePrefix="$(echo "${CONTECO_TYPE}" | tr '-' '_')_$stack"
	IFS=',' read -r -a volumes <<< "${CONTECO_DC_GLOBAL_VOLUME_INITIALISED}"
	for volumeSettings in ${volumes[@]};
	do
		volumeName=$(echo $volumeSettings | cut -d':' -f 1)
		volumeDir=$(echo $volumeSettings | cut -d':' -f 2)
		if [[ "$volumeName"  == "$volumePrefix"* ]] ; then
			executionplane --silent docker run -v ${volumeSettings} -v controlplane_repos:/conteco/pwd ${CONTECO_REGISTRY}${imageName} --interactive tar cvf ${rootPath}/modeco/volumes/${volumeName}.tar ${volumeDir}
		fi
	done;
)
